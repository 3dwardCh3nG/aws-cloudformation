AWS::CloudFormation::Init:
  configSets:
    install_all:
      - install_cfn
      - install_logs
  install_cfn:
    files:
      /etc/cfn/cfn-hup.conf:
        content:
          Fn::Join:
            - ''
            - - '[main]'
              - 'stack='
              - Ref: AWS::StackId
              - '\n'
              - 'region='
              - Ref: AWS::Region
              - '\n'
        mode: 000400
        owner: root
        group: root
      /etc/cfn/hooks.d/cfn-auto-reloader.conf:
        content:
          Fn::Join:
            - ''
            - - '[cfn-auto-reloader-hook]\n'
              - 'triggers=post.update\n'
              - 'path='
              - Fn::FindInMap: [ Properties, CouldFormationInit, ResourcePath ]
              - ' \n'
              - 'action=/opt/aws/bin/cfn-init -v '
              - '         --stack '
              - Ref: AWS::StackName
              - '         --resource '
              - Fn::FindInMap: [ Properties, CouldFormationInit, EC2ResourceName ]
              - '         --configsets install_all '
              - '         --region '
              - Ref: AWS::Region
              - '\n'
              - 'runas=root\n'
        mode: 000400
        owner: root
        group: root
    services:
      sysvinit:
        cfn-hup:
          enabled: 'true'
          ensureRunning: 'true'
          files:
            - /etc/cfn/cfn-hup.conf
            - /etc/cfn/hooks.d/cfn-auto-reloader.conf
  install_logs:
    packages:
      yum:
        awslogs: []
    files:
      /etc/awslogs/awslogs.conf:
        content:
          Fn::Join:
            - ''
            - - '[general]\n'
              - 'state_file= /var/lib/awslogs/agent-state\n'
              - '[/var/log/cloud-init.log]\n'
              - 'file = /var/log/cloud-init.log\n'
              - 'log_group_name = '
              - Fn::FindInMap: [ Properties, CouldFormationInit, CloudformationLogGroupName ]
              - '\n'
              - '\n'
              - 'log_stream_name = {instance_id}/cloud-init-output.log\n'
              - 'datetime_format = \n'
              - '[/var/log/cfn-init.log]\n'
              - 'file = /var/log/cfn-init.log\n'
              - 'log_group_name = '
              - Fn::FindInMap: [ Properties, CouldFormationInit, CloudformationLogGroupName ]
              - '\n'
              - 'log_stream_name = {instance_id}/cloud-init-output.log\n'
              - 'datetime_format = \n'
              - '[/var/log/cfn-init.log]\n'
              - 'file = /var/log/cfn-init.log\n'
              - 'log_group_name = '
              - Fn::FindInMap: [ Properties, CouldFormationInit, CloudformationLogGroupName ]
              - '\n'
              - 'log_stream_name = {instance_id}/cfn-init.log\n'
              - 'datetime_format = \n'
              - '[/var/log/cfn-hup.log]\n'
              - 'file = /var/log/cfn-hup.log\n'
              - 'log_group_name = '
              - Fn::FindInMap: [ Properties, CouldFormationInit, CloudformationLogGroupName ]
              - '\n'
              - 'log_stream_name = {instance_id}/cfn-hup.log\n'
              - 'datetime_format = \n'
              - '[/var/log/cfn-wire.log]\n'
              - 'file = /var/log/cfn-wire.log\n'
              - 'log_group_name = '
              - Fn::FindInMap: [ Properties, CouldFormationInit, CloudformationLogGroupName ]
              - '\n'
              - 'log_stream_name = {instance_id}/cfn-wire.log\n'
              - 'datetime_format = \n'
              - '[/var/log/httpd]\n'
              - 'file = /var/log/httpd/*\n'
              - 'log_group_name = '
              - Fn::FindInMap: [ Properties, CouldFormationInit, CloudformationLogGroupName ]
              - '\n'
              - 'log_stream_name = {instance_id}/httpd\n'
              - 'datetime_format = %d/%b/%Y:%H:%M:%S\n'
        mode: 000400
        owner: root
        group: root
      '/etc/awslogs/awscli.conf':
        content:
          Fn::Join:
            - ''
            - - '[plugins]\n'
              - 'cwlogs = cwlogs\n'
              - '[default]\n'
              - 'region = '
              - Ref: AWS::Region
              - '\n'
        mode: 000400
        owner: root
        group: root
    commands:
      01_create_state_directory:
        command: mkdir -p /var/awslogs/state
    services:
      sysvinit:
        awslongs:
          enabled: 'true'
          ensureRunning: 'true'
          files:
            - /etc/awslogs/awslogs.conf